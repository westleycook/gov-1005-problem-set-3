---
title: "Problem Set 3"
author: "Westley Cook"
date: "2/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading libraries that I assume will come in handy: tidyverse for its dplyr
# and ggplot2 packages, reprex in case I need to use it to ask for help online,
# janitor to clean my data, and gt because I'll have to produce a table.

library(tidyverse)
library(reprex)
library(janitor)
library(gt)

```

```{r read_in_data, include=FALSE}

# This r chunk reads in the xian data and cleans it.

xian <- read_csv("./raw-data/xian_data.csv",
                 
# Skipping three rows to get the column names to the top of the data frame
                 
                 skip = 3,

# Setting all the "undefined" values to NA

                 na = "undefined") %>% 
  
# Cleaning column names to make them easier to use
  
  clean_names()

# As I worked through the specifics of the commands and arguments I'd use to
# read in the data, I used glimpse() and summary() commands to  to look at the
# data (e.g. so I'd know how many rows to skip).


```

## Madlibs

```{r mad-lib-1, include=FALSE}

# This r chunk assigns an object to use in mad lib 1.

# Filtering xian data for only those rows where treatment is 1 (meaning those
# respondents who received treatment), then counting the number of rows and
# pulling the value of n and assigning it to the object treatment_respondents

treatment_respondents <- xian %>% 
  filter(treatment == 1) %>% 
  count() %>% 
  pull(n)

```

1. **`r treatment_respondents`** respondents are in the treatment group.

```{r mad-lib-2, include=FALSE}

# This r chunk assigns an object to use in mad lib 2.

# As above, filtering xian for those rows where treatment is 1;, then creating a
# column (gov_avg_in_treatment_group) to house the average of overall ratings
# for members of the treatment group, removing all the NA values because they're
# incompatible with the mean() operation. Pulling the result and assigning it to
# the object gov_avg_rating_in_treatment_group (which is probably too long a
# name, but it's descriptive).

gov_avg_rating_in_treatment_group <- xian %>% 
  filter(treatment == 1) %>% 
  summarize(gov_avg_in_treatment_group = mean(eval_gov_overall, 
                                              na.rm = TRUE)) %>% 
  pull(gov_avg_in_treatment_group)

```

2. Among respondents from the treatment group, the government has an average
**`r gov_avg_rating_in_treatment_group`** rating.

```{r mad-lib-3, include=FALSE}

# This r chunk assigns an object to use in mad lib 3.

# To find the most common rating for traffic, I count() the eval_gov_traffic
# column (which gives me two columns as a result, one for the values that make
# an appearance in the eval_gov_traffic column and one called n which shows how
# many times they appear). I then arrange the dataframe in descending order (so
# the most commonly-given rating is in the first row) and slice() that row. I
# pull() the value in the eval_gov_traffic column and assign it to
# most_common_traffic.

most_common_traffic <- xian %>% 
  count(eval_gov_traffic) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(eval_gov_traffic)

```

3. The most common rating for the government’s handling of traffic is 
**`r most_common_traffic`**.

```{r mad-lib-4, include=FALSE}

# This r chunk assigns an object to use in mad lib 4.

# I use filter() to leave only the rows in the dataframe where either overall,
# demolitions, or traffic rating is 10. I then count() those rows and pull() the
# n column to assign the total count (number of times a row in the dataframe
# contains 10 in any of the three rating categories) to any_ten_count.

any_ten_count <- xian %>% 
  filter(eval_gov_overall == 10 |
         eval_gov_demo == 10 |
         eval_gov_traffic == 10) %>% 
  count() %>% 
  pull(n)

```

4. **`r any_ten_count`** respondents have given the government a 10 rating
overall or on demolitions or on traffic.

```{r mad-lib-5, include=FALSE}

# This r chunk assigns an object to use in mad lib 5.

# I modify the code from mad lib 4 just slightly, replacing "or" bars (|) with
# commas in the filter function so it will leave me only with those rows in the
# dataframe in which ALL ratings were 10.

all_tens <- xian %>% 
  filter(eval_gov_overall == 10,
         eval_gov_demo == 10,
         eval_gov_traffic == 10) %>% 
  count() %>% 
  pull(n)

```

5. But only **`r all_tens`** gave the government a 10 rating overall and on
demolitions and on traffic.

```{r mad-lib-6, include=FALSE}

# This r chunk assigns an object to use in mad lib 6.

# Similar process to that in mad lib 5, but instead of filtering for just the
# value "A" (which would leave me with those respondents who ONLY get their news
# from Television and exclude those who get news from Television and other
# sources) I filter() for any value in the news_source column which contains the
# letter "A" using str_detect().

tv_respondents <- xian %>% 
  filter(str_detect(news_source, 
                    "A")) %>% 
  count() %>% 
  pull(n)

```

6. The number of respondents who get their news from Television is 
**`r tv_respondents`**.

```{r mad-lib-7, include=FALSE}

# This r chunk assigns an object to use in mad lib 7.

# As in mad lib 6, I use str_detect() to filter() for values in the location
# column which contain "square". After running that command and looking at the
# resulting table, I see that rows 1 and 4 are the first rows in the dataframe
# to contain their respective values, so I slice() those rows and pull() the
# values, assigning them to square_locations.

square_locations <- xian %>% 
  filter(str_detect(location, 
                    "square")) %>% 
  slice(1, 4) %>% 
  pull(location)

```

7. Of the 4 different locations where the respondents were surveyed, the
following two locations end with “square”: **`r square_locations`**.

## Data Wrangling

**1.a**

```{r table-untidy, echo=FALSE}

xian_subset_untidy <- xian %>% 
  select(respondent, 
         eval_gov_overall, 
         eval_gov_traffic, 
         eval_gov_demo)

xian_subset_untidy %>% 
  slice(1:10) %>% 
  gt() %>% 
  tab_header(title = "Untidy Data") %>% 
  tab_spanner(label = "Evaluations of Government Performance",
              columns = vars(eval_gov_overall, 
                             eval_gov_traffic, 
                             eval_gov_demo)
  ) %>% 
  cols_label(eval_gov_overall = "Overall",
             eval_gov_traffic = "Traffic",
             eval_gov_demo = "Demolitions",
             respondent = "Respondent Number")

```

**1.b**

```{r table-tidy, echo=FALSE}

xian_subset_untidy %>% 
  pivot_longer(cols = c(eval_gov_overall, 
                        eval_gov_traffic,
                        eval_gov_demo),
               names_to = "type",
               values_to = "rating") %>% 
  filter(respondent <= 10) %>% 
  mutate(type = recode(type, 
                       eval_gov_overall = "Overall",
                       eval_gov_traffic = "Traffic",
                       eval_gov_demo = "Demo")) %>% 
  gt() %>% 
  tab_header(title = "Tidy Data") %>% 
  cols_label(respondent = "Respondent Number",
             type = "Type of Evaluation",
             rating = "Performance Rating")

```

**2.** 

```{r table-potential-outcomes, echo=FALSE}

# Explain why you're leaving the NA in the table (to show that the question
# wasn't answered, but that we don't know what the potential outcome would have
# been)

xian %>% 
  select(respondent,
         treatment,
         control,
         eval_gov_overall) %>% 
  mutate(eval_under_treatment = ifelse(treatment == 1,
                                       eval_gov_overall,
                                       "?")) %>% 
  rename(eval_under_control = eval_gov_overall) %>% 
  mutate(eval_under_control = ifelse(treatment == 0,
                                     eval_under_control,
                                     "?")) %>% 
  slice(1:10) %>% 
  gt() %>% 
  tab_header(title = "Potential Outcomes") %>% 
  tab_spanner(label = "Potential Outcomes",
              columns = vars(eval_under_control,
                             eval_under_treatment)) %>% 
  tab_footnote(footnote = "Treatment is a 2 minute video about Chinese sports performance",
               locations = cells_title("title")) %>% 
  cols_label(respondent = "Respondent",
             treatment = "Treatment",
             control = "Control",
             eval_under_control = "Under Control",
             eval_under_treatment = "Under Treatment") %>% 
  cols_align(align = "center")

```

**3.**

```{r demographics-setup, include=FALSE}

load("r-data/demographics.Rdata")

xian_demographics <- xian %>% 
  inner_join(demographics, by = "respondent")

```

```{r table-demographics, echo=FALSE}

xian_demographics %>% 
  filter(treatment == 1) %>% 
  select(respondent, eval_gov_traffic, age, gender) %>% 
  arrange(desc(eval_gov_traffic)) %>%
  slice(1:5) %>% 
  gt() %>% 
  tab_header(title = "Highest Evaluators of Government Performance on Traffic:",
             subtitle = "Among Treated Individuals") %>% 
  tab_footnote(footnote = "Evaluation on Scale from 1 to 10",
               location = cells_title("title")) %>% 
  cols_label(respondent = "Respondent",
             eval_gov_traffic = "Evaluate Government Performance",
             age = "Age",
             gender = "Gender")

```

**4.**

```{r scatterplot-setup, include=FALSE}

eval_by_treatment_education <- xian_demographics %>% 
  mutate(treatment = as.factor(treatment)) %>%
# because it was giving me a warning  
  na.omit() %>% 
  group_by(education, treatment) %>%
  summarize(avg_eval = mean(eval_gov_overall))

```

```{r replicate-scatterplot, echo=FALSE}

eval_by_treatment_education %>% 
  ggplot(aes(x =  fct_relevel(education,
                              "Primary",
                              "Incomplete secondary",
                              "Complete secondary",
                              "Some university",
                              "University completed"),
             y = avg_eval,
             color = treatment)) +
  geom_point() +
  labs(title = "Government Performance Evaluations \n By Treatment Group \n and Education Level",
       x = "Education",
       y = "Average Evaluation") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "top",
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.line.y.left = element_line(),
        axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  scale_color_discrete(name = "Viewed Sports Video")

# ADD FORMATTING TO REPLICATE MODEL PLOT

```

**5.**

```{r gold-medal-setup, include=FALSE}

library(rvest)

olympics_html <- read_html("https://en.wikipedia.org/wiki/2008_Summer_Olympics")

olympic_table <- olympics_html %>% 
  html_nodes(css = "table") %>% 
  .[8] %>% 
  html_table()

olympic_df <- olympic_table %>% 
  as.data.frame()

```

```{r replicate-gold-medal-chart, echo=FALSE}

olympic_df %>% 
  slice(1:10) %>% 
    
  ggplot(aes(x = fct_reorder(Nation,
                             Gold,
                             .desc = TRUE),
             y = Gold)) +
  geom_col() + 
  ggtitle("Number of Gold Medals in 2008 Beijing Olympics") +
  xlab("Country") +
  ylab("Gold Medals") +
  theme_bw() +
  theme(panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.line.y.left = element_line()
        )

```

##### Worked With:
Brian Kim
